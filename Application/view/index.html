<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link href="css/index.css" rel="stylesheet">
</head>

<body onload="getCategories(); getLocations()">
    <div class="topnav">
        <a class="active" href="/index">Home</a>
        <a href="/team">Team</a>
        <a href="/about">About</a>

        <div class="login-container">
            <form action="/action_page.php">
                <input type="text" placeholder="Username" name="username">
                <input type="text" placeholder="Password" name="psw">
                <button type="submit">Login</button>
            </form>
        </div>
    </div>

    <div class="header">
        <form>
        	<div>
	            <h1>Safe SF</h1>
	            <h1>Team 2</h1>
            </div>
            
            <h2>Lets Start your search</h1>
            <div class="form-box">
                <div class="dropdown">
                    <button class="dropbtn" id="categoryButton">Categories</button>
                    <div class="dropdown-content" id="categoryDropDown">
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn" id="locationButton">Locations</button>
                    <div class="dropdown-content" id="locationDropDown">
                    </div>
                </div>

                <input class="search-field search" id="searchBox" name="location" type="text" placeholder="search"/>
                <button class="search-btn" type="button" onclick="search()">search</button>
            </div>
        </form>

        <div id="table">
        </div>
    </div>

    <script>
        var categories;
        var locations;

        function getCategories() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200)
                {
                    categories = xmlReq.response
                    populateDropdown(categories, "category");
                }
            }

            xmlReq.open('GET', '/categories', true);
            xmlReq.responseType = "json";
            xmlReq.send();
        }

        function getLocations() {
            var xmlReq = new XMLHttpRequest();

            xmlReq.onload = function() {
                if (xmlReq.status == 200)
                {
                    locations = xmlReq.response
                    populateDropdown(locations, "location");
                }
            }

            xmlReq.open('GET', '/locations', true);
            xmlReq.responseType = "json";
            xmlReq.send();
        }

        function populateDropdown(jsonData, field) {
            if(field === "category")
                var dropDown = document.getElementById("categoryDropDown");
            else if(field === "location")
                var dropDown = document.getElementById("locationDropDown");

            var div = document.createElement("div");
            div.innerHTML = "<a href='javascript:void(0);' onclick=\"selectDropdown('None', '" + field + "')\">None</a>";
            dropDown.appendChild(div);

            for(var i = 0; i < jsonData.length; i++)
            {
                if(field === "category")
                    var selection = jsonData[i].category;
                else if(field === "location")
                    var selection = jsonData[i].location;

                div = document.createElement("div");
                div.innerHTML = "<a href='javascript:void(0);' onclick=\"selectDropdown('" + selection + "', '" + field + "')\">" + selection + "</a>";
                dropDown.appendChild(div);
            }
        }

        function selectDropdown(selection, field) {
            if(field === "category")
                var dropDownButton = "categoryButton";
            else if(field === "location")
                var dropDownButton = "locationButton";

            var button = document.getElementById(dropDownButton);

            if(selection === "None")
            {
                if(field === "category")
                    button.innerHTML = "Categories";
                else if(field === "location")
                    button.innerHTML = "Locations";
            }
            else
                button.innerHTML = selection;
        }

    	function search() {
    		var xmlReq = new XMLHttpRequest();

			xmlReq.onload = function() {
				if (xmlReq.status == 200)
                    createTable(xmlReq.response);
			}

			xmlReq.open('GET', '/search' + getSearchParams(), true);
			xmlReq.responseType = "json";
			xmlReq.send(null);
    	}

    	function getSearchParams() {
    		var category = document.getElementById("categoryButton").innerHTML;
    		var category_id = getIdOfValue(categories, "category", category);

    		var location = document.getElementById("locationButton").innerHTML;
    		var location_id = getIdOfValue(locations, "location", location);

    		var user_entry = document.getElementById("searchBox").value;

    		var requestParam = "?"
    		var firstParam = true;

    		if(category != "Categories")
    		{
    			requestParam += "category_id=" + category_id;
    			firstParam = false;
    		}

    		if(location != "Locations")
    		{
	    		if(!firstParam)
	    			requestParam += "&";

    			requestParam += "location_id=" + location_id;
    			firstParam = false;
    		}

    		if(user_entry != "")
    		{
	    		if(!firstParam)
	    			requestParam += "&";
	    		
    			requestParam += "user_entry=" + user_entry;
    		}

    		return requestParam;
    	}

    	function getIdOfValue(jsonData, field, value) {
    		for(var i = 0; i < jsonData.length; i++) {
    			if(field === "category") {
    				if(jsonData[i].category === value)
    					return jsonData[i].category_id;
    			}
    			else if(field === "location") {
    				if(jsonData[i].location === value)
    					return jsonData[i].location_id;
    			}
    		}
    	}

        function getValueOfId(jsonData, field, id) {
            for(var i = 0; i < jsonData.length; i++) {
                if(field === "category_id") {
                    if(jsonData[i].category_id === id)
                        return jsonData[i].category;
                }
                else if(field === "location_id") {
                    if(jsonData[i].location_id === id)
                        return jsonData[i].location;
                }
            }
        }

        function createTable(searchResults) {
            var table = document.createElement("table");

            for(var i = 0; i < Math.ceil(searchResults.length/5); i++)
            {
                var row = table.insertRow(-1);

                for(var j = 0; j < 5; j++)
                {
                    var cell = row.insertCell(-1);

                    if(i*5 + j < searchResults.length)
                    {
                        var report = searchResults[i*5 + j];
                        var category = getValueOfId(categories, "category_id", report.category_id);
                        var image = "report_images/" + report.report_id + ".jpg";

                        if(locations[parseInt(report.location_id) - 1] == null)
                        	var location = "";
                        else
                            var location = getValueOfId(locations, "location_id", report.location_id);

                        cell.innerHTML = "<div class='card'>" +
                                          "<img class='cardImage' src='" + image + "'><div>" +
                                          category + "</div><div>" +
                                          report.details + "</div><div>" +
                                          location + "</div><div>" +
                                          report.insert_date + "</div><div>" +
                                          report.status + "</div></div>";
                    }
                }
            }

            var tableContainer = document.getElementById("table");
            tableContainer.innerHTML = "";
            tableContainer.appendChild(table);
        }
    </script>
</body>

</html>